<project name="JMeter-Ant-Parallel" default="report" basedir=".">
    <!-- JMeter installation path -->
    <property name="jmeter.home" value="/opt/apache-jmeter" />
    <property name="jmeter.bin" value="D:/JMeter/apache-jmeter-5.6.3/apache-jmeter-5.6.3/bin" />
    <property name="jmeter.results.dir" value="build/jmeter-results" />
    <property name="jmeter.report.dir" value="build/jmeter-html-report" />

    <!-- JMeter jars -->
    <path id="jmeter.classpath">
        <fileset dir=D:/JMeter/apache-jmeter-5.6.3/apache-jmeter-5.6.3/lib" includes="**/*.jar"/>
        <fileset dir="D:/JMeter/apache-jmeter-5.6.3/apache-jmeter-5.6.3/lib/ext" includes="**/*.jar"/>
    </path>

    <taskdef name="jmeter" 
             classname="org.apache.jorphan.ant.JMeterTask" 
             classpathref="jmeter.classpath" />

    <!-- Prepare folders -->
    <target name="init">
        <mkdir dir="${jmeter.results.dir}" />
        <mkdir dir="${jmeter.report.dir}" />
    </target>

    <!-- Run all JMX files in parallel -->
    <target name="run-tests" depends="init">
        <parallel threadCount="4" failonany="true">
            <fileset dir="Test Plans" includes="*.jmx">
                <sequential>
                    <jmeter testplan="@{filename}"
                            resultlog="${jmeter.results.dir}/@{basename}.jtl" />
                </sequential>
            </fileset>
        </parallel>
    </target>

    <!-- Generate consolidated report -->
    <target name="report" depends="run-tests">
        <java classname="org.apache.jmeter.report.dashboard.ReportGenerator" fork="true">
            <classpath refid="jmeter.classpath" />
            <arg line="-o ${jmeter.report.dir}" />
            <arg line="-g ${jmeter.results.dir}/*.jtl" />
        </java>
    </target>
</project>
