<?xml version="1.0" encoding="UTF-8"?>
<project name="JMeter-Parallel-Tests" default="report" basedir=".">
    <!-- ========================================================= -->
    <!-- PATHS - Update according to your JMeter installation     -->
    <!-- ========================================================= -->
    <property name="jmeter.home" location="D:\JMeter\apache-jmeter-5.6.3\apache-jmeter-5.6.3"/>
    <property name="test.dir" location="tests"/> <!-- folder containing your .jmx files -->
    <property name="results.dir" location="build/results"/>
    <property name="report.dir" location="build/jmeter-html-report"/>

    <!-- ========================================================= -->
    <!-- Define JMeter task for Ant -->
    <!-- ========================================================= -->
    <taskdef name="jmeter" classname="org.apache.jorphan.ant.JMeterTask">
        <classpath>
            <pathelement location="${jmeter.home}/lib/jorphan.jar"/>
            <pathelement location="${jmeter.home}/lib/ApacheJMeter_core.jar"/>
            <pathelement location="${jmeter.home}/lib/ApacheJMeter_components.jar"/>
            <pathelement location="${jmeter.home}/lib/ApacheJMeter_http.jar"/>
            <!-- Add more jars if your JMX uses other samplers/plugins -->
        </classpath>
    </taskdef>

    <!-- ========================================================= -->
    <!-- Create directories -->
    <!-- ========================================================= -->
    <target name="clean">
        <delete dir="build"/>
    </target>

    <target name="prepare">
        <mkdir dir="${results.dir}"/>
        <mkdir dir="${report.dir}"/>
    </target>

    <!-- ========================================================= -->
    <!-- Run JMeter tests in parallel -->
    <!-- ========================================================= -->
    <target name="run-tests" depends="prepare">
        <taskdef resource="net/sf/antcontrib/antlib.xml"/>
        <path id="jmx.files">
            <fileset dir="${test.dir}" includes="*.jmx"/>
        </path>

        <!-- Use ant-contrib foreach for parallel execution -->
        <foreach target="run-single-test" param="jmxfile" parallel="true">
            <path>
                <fileset dir="${test.dir}" includes="*.jmx"/>
            </path>
        </foreach>
    </target>

    <!-- Run single JMeter test -->
    <target name="run-single-test">
        <jmeter jmeterhome="${jmeter.home}"
                testplan="${test.dir}/${jmxfile}"
                resultlog="${results.dir}/${jmxfile}.jtl"/>
    </target>

    <!-- ========================================================= -->
    <!-- Generate HTML report -->
    <!-- ========================================================= -->
    <target name="report" depends="run-tests">
        <jmeter jmeterhome="${jmeter.home}"
                reportgenerator="true"
                resultlog="${results.dir}/*.jtl"
                reportoutput="${report.dir}"/>
    </target>
</project>
