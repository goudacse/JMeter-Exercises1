<?xml version="1.0" encoding="UTF-8"?>
<project name="JMeterParallelRun" default="report" basedir=".">

    <!-- Path to JMeter installation -->
    <property name="jmeter.home" value="${env.JMETER_HOME}" />
    <property name="testplan.dir" value="Test Plans" />
    <property name="results.dir" value="build/results" />
    <property name="report.dir" value="build/jmeter-html-report" />

    <!-- Clean previous results -->
    <target name="clean">
        <delete dir="${results.dir}" />
        <delete dir="${report.dir}" />
    </target>

    <!-- Run all JMX files in parallel dynamically -->
    <target name="run-tests" depends="clean">
        <mkdir dir="${results.dir}" />

        <!-- Fileset to select all JMX files -->
        <fileset id="jmx.files" dir="${testplan.dir}" includes="*.jmx" />

        <!-- Parallel execution -->
        <parallel threadCount="4" timeout="0">
            <foreach target="run-single" param="file">
                <path>
                    <fileset refid="jmx.files" />
                </path>
            </foreach>
        </parallel>
    </target>

    <!-- Execute a single JMX -->
    <target name="run-single">
        <echo message="Running @{file}" />
        <exec executable="${jmeter.home}\bin\jmeter.bat">
            <arg value="-n" />
            <arg value="-t" />
            <arg value="@{file}" />
            <arg value="-l" />
            <arg value="${results.dir}\${basename:@{file}}.jtl" />
        </exec>
    </target>

    <!-- Generate consolidated HTML report -->
    <target name="report" depends="run-tests">
        <mkdir dir="${report.dir}" />
        <exec executable="${jmeter.home}\bin\jmeter.bat">
            <arg value="-g" />
            <arg value="${results.dir}" />
            <arg value="-o" />
            <arg value="${report.dir}" />
        </exec>
    </target>

</project>
